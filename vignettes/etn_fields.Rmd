---
title: "ETN field definitions"
author: "Peter Desmet & Filip Waumans"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(etn)
library(DBI)
library(kableExtra)
```

```{r include=FALSE}
con <- connect_to_etn(Sys.getenv("userid"), Sys.getenv("pwd"))
etn_fields <- dbGetQuery(con, "SELECT * FROM vliz.datapaper_metadata_fields")
```

Field definitions are managed in the ETN database, not in this package, but suggestions/corrections can be reported as in issue (see the [contributing guide](../.github/CONTRIBUTING.md)).

```{r include=FALSE}
# Create helper function to display tables for each view
view_table <- function(view_name) {
  view_data <-
    etn_fields %>%
    # Filter on view
    filter(viewname == view_name) %>%
    # Select columns
    select(field, definition, unit_definition, database_data_type) %>%
    # Rename some columns
    rename(
      example = unit_definition,
      `data type` = database_data_type
    ) %>%
    # Convert quotes to backticks, so examples are shown as markdown monospaced code
    mutate(across(everything(), ~ str_replace_all(., "\"", "`"))) %>%
    # Wrap "field" in backticks
    mutate(field = if_else(!is.na(field), paste0("`", field, "`"), field)) %>%
    # Convert "NA" to empty strings
    mutate(across(everything(), ~ replace_na(., ""))) %>%
    # Rename data types
    mutate(`data type` = recode(`data type`,
      "character varying" = "character",
      "text" = "character",
      "double precision" = "double",
      "timestamp without time zone" = "datetime",
      "smallint" = "integer"
    ))
  
  view_kable <-
    kable(view_data) %>%
    # field: some have long names, break-word will force them to wrap
    column_spec(1, width = "25%", extra_css = "word-break: break-word") %>%
    # definition
    column_spec(2, width = "40%") %>%
    # example
    column_spec(3, width = "25%") %>%
    # data type
    column_spec(4, width = "10%")
  
  return(view_kable)
}
```

## Projects

Related function: `get_projects()`.

```{r echo=FALSE}
view_table("projects_view2")
```

## Animals

Related function: `get_animals()`.

```{r echo=FALSE}
view_table("animals_view2")
```

## Tags

Related function: `get_tags()`.

```{r echo=FALSE}
view_table("tags_view2")
```

## Deployments

Related function: `get_deployments()`.

```{r echo=FALSE}
view_table("deployments_view2")
```

## Receivers

Related function: `get_receivers()`.

```{r echo=FALSE}
view_table("receivers_view2")
```

## Detections

Related function: `get_detections()`.

```{r echo=FALSE}
view_table("detections_view2")
```
